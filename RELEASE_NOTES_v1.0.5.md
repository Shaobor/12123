# Release v1.0.5

## 修复

- **修复**: 改进配置流程中的错误处理和错误消息管理

  - 修复响应体重复读取问题，避免解析JSON时出错

  - 修复 `acw_tc` 可能为 None 的问题，使用安全的默认值处理

  - 修复 `jsessionid` 切片可能失败的问题，添加长度检查

  - 修复二次请求失败时缺少返回语句的问题

  - 添加 session 自动恢复功能，当 session 丢失时自动重新创建

## 问题修复

### 错误处理改进

- 修复了错误：`发送QR查询请求时出错:` - 现在会显示详细的错误类型和信息

- 修复了错误：`Session丢失，请重新配置` - 现在会自动尝试恢复 session

- 修复了响应体重复读取导致的解析错误

- 统一了所有错误消息，使用 `ERROR_MESSAGES` 统一管理

### 错误消息优化

- 所有错误消息现在都通过 `ERROR_MESSAGES` 获取，便于维护和国际化

- 添加了新的错误消息定义：
  - `session_closed`: "会话已关闭，请重新配置"
  - `session_recreate_failed`: "重新创建会话失败，请重试"
  - `auth_failed`: "认证过程中获取用户信息失败"
  - `missing_cookies`: "登录认证失败，未获取到必需的认证信息"

- 改进了错误提示文本，使其更加友好和清晰

### 代码质量提升

- 改进了错误日志，现在会显示异常类型和完整错误信息

- 增强了防御性编程，添加了更多的空值检查和边界条件处理

- 简化了 session 检查条件，代码更加清晰

## 安装

### 使用 HACS（推荐）

1. 确保已安装 [HACS](https://hacs.xyz/)

2. 在 HACS 中，进入"集成"页面

3. 点击右上角的三个点，选择"自定义仓库"

4. 添加此仓库 URL：`https://github.com/Shaobor/12123`

5. 选择类别为"集成"

6. 点击"添加"

7. 在集成页面搜索"12123"并安装

8. 更新到最新版本

### 手动安装

1. 下载此版本的源代码（zip 或 tar.gz）

2. 将 `custom_components/12123` 文件夹复制到你的 Home Assistant `custom_components` 目录

3. 重启 Home Assistant

## 配置

在 Home Assistant 中通过 UI 配置此集成：

1. 进入"设置" > "设备与服务"

2. 点击"添加集成"

3. 搜索"12123"

4. 按照提示完成配置

## 注意事项

- 本集成是第三方开发，与12123官方无关

- 使用本集成需要遵守相关法律法规和12123的服务条款

- 如果遇到问题，请开启 debug 日志查看详细信息

- 本次更新主要是 bug 修复和错误处理改进，不影响现有配置
