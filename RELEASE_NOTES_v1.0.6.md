# Release v1.0.6

## 修复

- **修复**: 改进保活机制，使用带 ticket 的登录 URL 进行保活，自动重定向判断会话状态

  - 保活请求使用配置中保存的原始登录 URL（带 ticket）
  
  - 自动跟随重定向，通过最终 URL 判断会话状态
  
  - 如果重定向到 `/views/member/`，说明会话有效
  
  - 如果重定向到 `/m/login`，说明会话失效（被踢掉登录状态）

- **改进**: 优化保活判断逻辑，优先检查最终重定向 URL

  - 即使状态码是 404，如果重定向到 `/views/member/`，也认为会话有效
  
  - 这样可以更准确地判断会话状态，避免误判

- **改进**: 优化日志输出，显示完整的 URL 信息

  - 所有保活相关的日志现在显示完整的 URL，不再截断
  
  - 便于调试和问题排查

- **修复**: 修复驾驶证状态显示问题，优先使用状态文字描述

  - 之前显示的是状态代码（如"A"），现在优先使用状态文字描述（如"正常"）
  
  - 优先使用 `ztStr` 或 `ztstr` 字段，如果没有再使用 `zt` 状态代码
  
  - 确保用户看到的是可读的状态文字，而不是代码

## 问题修复

### 保活机制优化

- 改回使用带 ticket 的登录 URL 进行保活（与 Node-RED 测试一致）
- 自动跟随重定向，通过最终 URL 判断会话状态
- 即使 ticket URL 过期（返回 404），只要重定向到已登录页面，也认为会话有效

### 日志改进

- 保活日志现在显示完整的 URL，不再截断
- 便于查看完整的 ticket 和重定向信息

### 驾驶证状态显示修复

- 修复了驾驶证状态显示为代码（如"A"）而不是文字（如"正常"）的问题
- 现在优先使用 `ztStr` 或 `ztstr` 字段显示状态文字描述
- 如果状态文字描述不可用，才会回退到使用 `zt` 状态代码

## 安装

### 使用 HACS（推荐）

1. 确保已安装 [HACS](https://hacs.xyz/)

2. 在 HACS 中，进入"集成"页面

3. 点击右上角的三个点，选择"自定义仓库"

4. 添加此仓库 URL：`https://github.com/Shaobor/12123`

5. 选择类别为"集成"

6. 点击"添加"

7. 在集成页面搜索"12123"并安装

8. 更新到最新版本

### 手动安装

1. 下载此版本的源代码（zip 或 tar.gz）

2. 将 `custom_components/12123` 文件夹复制到你的 Home Assistant `custom_components` 目录

3. 重启 Home Assistant

## 配置

在 Home Assistant 中通过 UI 配置此集成：

1. 进入"设置" > "设备与服务"

2. 点击"添加集成"

3. 搜索"12123"

4. 按照提示完成配置

## 注意事项

- 本集成是第三方开发，与12123官方无关

- 使用本集成需要遵守相关法律法规和12123的服务条款

- 如果遇到问题，请开启 debug 日志查看详细信息

